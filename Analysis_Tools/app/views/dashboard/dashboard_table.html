<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_table.css') }}">

<!-- Dashboard Controls -->
<div class="dashboard-controls">
  <div class="control-row">
    <!-- Date Selector -->
    <div class="control-group">
      <label for="dateSelect">Date:</label>
      <select id="dateSelect" name="date" onchange="window.location.href='/?date='+this.value+'&mtype={{ mtype }}'">
        {% for d in dates %}
        <option value="{{ d }}" {% if d == selected_date %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Moneyness Type Filter -->
    <div class="control-group">
      <div class="btn-group">
        <button class="filter-btn {% if mtype == 'TOTAL' %}active{% endif %}" 
                onclick="window.location.href='/?date={{ selected_date }}&mtype=TOTAL'">
          TOTAL
        </button>
        <button class="filter-btn {% if mtype == 'ITM' %}active{% endif %}" 
                onclick="window.location.href='/?date={{ selected_date }}&mtype=ITM'">
          ITM
        </button>
        <button class="filter-btn {% if mtype == 'OTM' %}active{% endif %}" 
                onclick="window.location.href='/?date={{ selected_date }}&mtype=OTM'">
          OTM
        </button>
      </div>
    </div>

    <!-- Export Button -->
    <div class="control-group">
      <a href="{{ url_for('dashboard.export_dashboard', date=selected_date, mtype=mtype) }}" 
         class="btn-export" 
         title="Export to Excel">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Export Excel
      </a>
    </div>
  </div>
</div>

<style>
.dashboard-controls {
  background: white;
  padding: 15px 20px;
  margin-bottom: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.control-row {
  display: flex;
  gap: 20px;
  align-items: center;
  flex-wrap: wrap;
}

.control-group {
  display: flex;
  align-items: center;
  gap: 10px;
}

.control-group label {
  font-weight: 600;
  font-size: 14px;
  color: #333;
}

.control-group select {
  padding: 8px 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  background: white;
  cursor: pointer;
  min-width: 150px;
}

.control-group select:focus {
  outline: none;
  border-color: #8B2432;
}

.btn-group {
  display: flex;
  gap: 5px;
}

.filter-btn {
  padding: 8px 20px;
  border: 2px solid #ddd;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s;
}

.filter-btn:hover {
  border-color: #8B2432;
  color: #8B2432;
}

.filter-btn.active {
  background: #8B2432;
  color: white;
  border-color: #8B2432;
}

.btn-export {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: #28a745;
  color: white;
  border-radius: 6px;
  text-decoration: none;
  font-weight: 600;
  font-size: 14px;
  transition: background 0.2s;
}

.btn-export:hover {
  background: #218838;
}
</style>

<div class="table-wrapper">
  <div class="table-container">
    <table id="derivativesTable" class="derivatives-table dataTable">
      <thead>
        <tr>
          <th rowspan="2" class="col-stock">Stock</th>
          <th colspan="2">Call Δ+</th>
          <th colspan="2">Call Δ−</th>
          <th colspan="2">Call Vega+</th>
          <th colspan="2">Call Vega−</th>
          <th rowspan="2">Call ATV</th>
          <th rowspan="2">Call AMoney</th>
          <th rowspan="2" class="col-center">Close</th>
          <th rowspan="2" class="col-center">RSI</th>
          <th colspan="2">Put Δ+</th>
          <th colspan="2">Put Δ−</th>
          <th colspan="2">Put Vega+</th>
          <th colspan="2">Put Vega−</th>
          <th rowspan="2">Put ATV</th>
          <th rowspan="2">Put AMoney</th>
        </tr>
        <tr>
          <th>Strike</th><th>%</th>
          <th>Strike</th><th>%</th>
          <th>Strike</th><th>%</th>
          <th>Strike</th><th>%</th>
          <th>Strike</th><th>%</th>
          <th>Strike</th><th>%</th>
          <th>Strike</th><th>%</th>
          <th>Strike</th><th>%</th>
        </tr>
      </thead>
      <tbody>
        {% for row in data %}
        <tr>
          <td class="cell-stock"><a href="{{ url_for('stock.stock_detail', ticker=row.stock) }}">{{ row.stock }}</a></td>
          <td>{{ row.call_delta_pos_strike }}</td>
          <td>{{ row.call_delta_pos_pct }}</td>
          <td>{{ row.call_delta_neg_strike }}</td>
          <td>{{ row.call_delta_neg_pct }}</td>
          <td>{{ row.call_vega_pos_strike }}</td>
          <td>{{ row.call_vega_pos_pct }}</td>
          <td>{{ row.call_vega_neg_strike }}</td>
          <td>{{ row.call_vega_neg_pct }}</td>
          <td>{{ "{:.2f}".format(row.call_total_tradval or 0) }}</td>
          <td>{{ "{:.2f}".format(row.call_total_money or 0) }}</td>
          <td class="col-center">{{ "{:.2f}".format(row.closing_price or 0) }}</td>
          <td class="col-center">{{ "{:.2f}".format(row.rsi or 0) }}</td>
          <td>{{ row.put_delta_pos_strike }}</td>
          <td>{{ row.put_delta_pos_pct }}</td>
          <td>{{ row.put_delta_neg_strike }}</td>
          <td>{{ row.put_delta_neg_pct }}</td>
          <td>{{ row.put_vega_pos_strike }}</td>
          <td>{{ row.put_vega_pos_pct }}</td>
          <td>{{ row.put_vega_neg_strike }}</td>
          <td>{{ row.put_vega_neg_pct }}</td>
          <td>{{ "{:.2f}".format(row.put_total_tradval or 0) }}</td>
          <td>{{ "{:.2f}".format(row.put_total_money or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
</div>
</div>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
<script src="{{ url_for('static', filename='js/dashboard_table.js') }}"></script>

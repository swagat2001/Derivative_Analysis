{% extends "base.html" %}
{% block title %}Technical Screener{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/technical_screener.css') }}">
{% endblock %}

{% block content %}
<div class="technical-container">

    <div class="technical-header">
        <h1>üìà Technical Screener</h1>
        <p>RSI, MACD, SMA and ADX based stock screening with visual heatmaps</p>
    </div>

    <div class="technical-controls">
        <label>Select Date:</label>
        <select onchange="window.location.href='/screener/technical?date='+this.value;">
            {% for d in dates %}
            <option value="{{ d }}" {% if d == selected_date %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
        </select>
    </div>

    {% if tech_data %}

    <!-- RSI Based Section -->
    <div class="tech-section">
        <div class="section-title">üìä RSI-Based Analysis</div>
        <div class="tech-cards-grid">
            <!-- RSI Overbought -->
            <div class="tech-card">
                <div class="tech-card-header">
                    <div class="tech-card-title">RSI Overbought (RSI > 80)</div>
                </div>
                <table class="tech-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Stock</th>
                            <th>Price</th>
                            <th>RSI</th>
                            <th>Signal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in tech_data.rsi_overbought %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td><a href="/stock/{{ item.ticker }}" class="ticker-link">{{ item.ticker }}</a></td>
                            <td>‚Çπ{{ "%.2f"|format(item.underlying_price) }}</td>
                            <td><span class="rsi-value overbought">{{ "%.1f"|format(item.rsi_14) }}</span></td>
                            <td><span class="signal-badge {{ item.signal|lower }}">{{ item.signal }}</span></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="no-data-message">No overbought stocks found</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- RSI Oversold -->
            <div class="tech-card">
                <div class="tech-card-header">
                    <div class="tech-card-title">RSI Oversold (RSI < 20)</div>
                </div>
                <table class="tech-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Stock</th>
                            <th>Price</th>
                            <th>RSI</th>
                            <th>Signal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in tech_data.rsi_oversold %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td><a href="/stock/{{ item.ticker }}" class="ticker-link">{{ item.ticker }}</a></td>
                            <td>‚Çπ{{ "%.2f"|format(item.underlying_price) }}</td>
                            <td><span class="rsi-value oversold">{{ "%.1f"|format(item.rsi_14) }}</span></td>
                            <td><span class="signal-badge {{ item.signal|lower }}">{{ item.signal }}</span></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="no-data-message">No oversold stocks found</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MACD Based Section -->
    <div class="tech-section">
        <div class="section-title">üìâ MACD-Based Analysis</div>
        <div class="tech-cards-grid">
            <!-- MACD Bullish Crossover -->
            <div class="tech-card">
                <div class="tech-card-header">
                    <div class="tech-card-title">MACD Bullish Crossover</div>
                </div>
                <table class="tech-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Stock</th>
                            <th>Price</th>
                            <th>MACD</th>
                            <th>Signal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in tech_data.macd_bullish %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td><a href="/stock/{{ item.ticker }}" class="ticker-link">{{ item.ticker }}</a></td>
                            <td>‚Çπ{{ "%.2f"|format(item.underlying_price) }}</td>
                            <td class="positive">{{ "%.2f"|format(item.macd) }}</td>
                            <td><span class="signal-badge {{ item.signal|lower }}">{{ item.signal }}</span></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="no-data-message">No bullish crossovers found</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- MACD Bearish Crossover -->
            <div class="tech-card">
                <div class="tech-card-header">
                    <div class="tech-card-title">MACD Bearish Crossover</div>
                </div>
                <table class="tech-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Stock</th>
                            <th>Price</th>
                            <th>MACD</th>
                            <th>Signal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in tech_data.macd_bearish %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td><a href="/stock/{{ item.ticker }}" class="ticker-link">{{ item.ticker }}</a></td>
                            <td>‚Çπ{{ "%.2f"|format(item.underlying_price) }}</td>
                            <td class="negative">{{ "%.2f"|format(item.macd) }}</td>
                            <td><span class="signal-badge {{ item.signal|lower }}">{{ item.signal }}</span></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="no-data-message">No bearish crossovers found</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SMA Based Section -->
    <div class="tech-section">
        <div class="section-title">üìà SMA-Based Analysis</div>
        <div class="tech-cards-grid">
            <!-- Above Both SMA -->
            <div class="tech-card">
                <div class="tech-card-header">
                    <div class="tech-card-title">Above 50 & 200 SMA (Bullish)</div>
                </div>
                <table class="tech-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Stock</th>
                            <th>Price</th>
                            <th>% from 200 SMA</th>
                            <th>RSI</th>
                            <th>Signal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in tech_data.above_sma %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td><a href="/stock/{{ item.ticker }}" class="ticker-link">{{ item.ticker }}</a></td>
                            <td>‚Çπ{{ "%.2f"|format(item.underlying_price) }}</td>
                            <td class="positive">{{ "%+.2f"|format(item.dist_from_200sma_pct) }}%</td>
                            <td>{{ "%.1f"|format(item.rsi_14) if item.rsi_14 else 'N/A' }}</td>
                            <td><span class="signal-badge {{ item.signal|lower }}">{{ item.signal }}</span></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" class="no-data-message">No stocks above both SMAs</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Below Both SMA -->
            <div class="tech-card">
                <div class="tech-card-header">
                    <div class="tech-card-title">Below 50 & 200 SMA (Bearish)</div>
                </div>
                <table class="tech-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Stock</th>
                            <th>Price</th>
                            <th>% from 200 SMA</th>
                            <th>RSI</th>
                            <th>Signal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in tech_data.below_sma %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td><a href="/stock/{{ item.ticker }}" class="ticker-link">{{ item.ticker }}</a></td>
                            <td>‚Çπ{{ "%.2f"|format(item.underlying_price) }}</td>
                            <td class="negative">{{ "%+.2f"|format(item.dist_from_200sma_pct) }}%</td>
                            <td>{{ "%.1f"|format(item.rsi_14) if item.rsi_14 else 'N/A' }}</td>
                            <td><span class="signal-badge {{ item.signal|lower }}">{{ item.signal }}</span></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" class="no-data-message">No stocks below both SMAs</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ADX Based Section -->
    <div class="tech-section">
        <div class="section-title">üí™ Strong Trending Stocks (ADX > 25)</div>
        <div class="tech-cards-grid">
            <div class="tech-card tech-card-full">
                <div class="tech-card-header">
                    <div class="tech-card-title">Strong Trending Stocks</div>
                </div>
                <table class="tech-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Stock</th>
                            <th>Price</th>
                            <th>ADX</th>
                            <th>RSI</th>
                            <th>Signal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in tech_data.strong_trend %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td><a href="/stock/{{ item.ticker }}" class="ticker-link">{{ item.ticker }}</a></td>
                            <td>‚Çπ{{ "%.2f"|format(item.underlying_price) }}</td>
                            <td><strong>{{ "%.1f"|format(item.adx_14) }}</strong></td>
                            <td>{{ "%.1f"|format(item.rsi_14) if item.rsi_14 else 'N/A' }}</td>
                            <td><span class="signal-badge {{ item.signal|lower }}">{{ item.signal }}</span></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" class="no-data-message">No strong trending stocks found</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ============================================================= -->
    <!-- HEATMAP SECTIONS WITH COUNTS AND TOGGLE -->
    <!-- ============================================================= -->
    
    <!-- RSI Heatmap - 6 Categories -->
    <div class="tech-section heatmap-section">
        <div class="section-title">üå°Ô∏è RSI Heatmap</div>
        
        <div class="heatmap-container" id="rsi-heatmap">
            <div class="heatmap-legend">
                <div class="legend-item active" data-filter="rsi-overbought" onclick="toggleHeatmapFilter('rsi-heatmap', 'rsi-overbought', this)">
                    <span class="legend-color rsi-overbought"></span>
                    <span>RSI > 80 (Overbought)</span>
                    <span class="legend-count" id="rsi-overbought-count">0</span>
                </div>
                <div class="legend-item active" data-filter="rsi-strong-bullish" onclick="toggleHeatmapFilter('rsi-heatmap', 'rsi-strong-bullish', this)">
                    <span class="legend-color rsi-strong-bullish"></span>
                    <span>RSI 60-80 (Strong Bullish)</span>
                    <span class="legend-count" id="rsi-strong-bullish-count">0</span>
                </div>
                <div class="legend-item active" data-filter="rsi-mild-bullish" onclick="toggleHeatmapFilter('rsi-heatmap', 'rsi-mild-bullish', this)">
                    <span class="legend-color rsi-mild-bullish"></span>
                    <span>RSI 50-60 (Mild Bullish)</span>
                    <span class="legend-count" id="rsi-mild-bullish-count">0</span>
                </div>
                <div class="legend-item active" data-filter="rsi-mild-bearish" onclick="toggleHeatmapFilter('rsi-heatmap', 'rsi-mild-bearish', this)">
                    <span class="legend-color rsi-mild-bearish"></span>
                    <span>RSI 40-50 (Mild Bearish)</span>
                    <span class="legend-count" id="rsi-mild-bearish-count">0</span>
                </div>
                <div class="legend-item active" data-filter="rsi-strong-bearish" onclick="toggleHeatmapFilter('rsi-heatmap', 'rsi-strong-bearish', this)">
                    <span class="legend-color rsi-strong-bearish"></span>
                    <span>RSI 20-40 (Strong Bearish)</span>
                    <span class="legend-count" id="rsi-strong-bearish-count">0</span>
                </div>
                <div class="legend-item active" data-filter="rsi-oversold" onclick="toggleHeatmapFilter('rsi-heatmap', 'rsi-oversold', this)">
                    <span class="legend-color rsi-oversold"></span>
                    <span>RSI < 20 (Oversold)</span>
                    <span class="legend-count" id="rsi-oversold-count">0</span>
                </div>
            </div>
            
            <div class="heatmap-grid">
                {% for item in tech_data.heatmap %}
                {% if item.rsi_14 and item.rsi_14 > 80 %}
                    {% set rsi_class = 'rsi-overbought' %}
                {% elif item.rsi_14 and item.rsi_14 >= 60 %}
                    {% set rsi_class = 'rsi-strong-bullish' %}
                {% elif item.rsi_14 and item.rsi_14 >= 50 %}
                    {% set rsi_class = 'rsi-mild-bullish' %}
                {% elif item.rsi_14 and item.rsi_14 >= 40 %}
                    {% set rsi_class = 'rsi-mild-bearish' %}
                {% elif item.rsi_14 and item.rsi_14 >= 20 %}
                    {% set rsi_class = 'rsi-strong-bearish' %}
                {% elif item.rsi_14 %}
                    {% set rsi_class = 'rsi-oversold' %}
                {% else %}
                    {% set rsi_class = 'rsi-mild-bearish' %}
                {% endif %}
                <a href="/stock/{{ item.ticker }}" class="heatmap-cell {{ rsi_class }}" data-category="{{ rsi_class }}" title="{{ item.ticker }}: RSI={{ '%.1f'|format(item.rsi_14) if item.rsi_14 else 'N/A' }}">
                    <div class="ticker">{{ item.ticker }}</div>
                    <div class="value">{{ "%.0f"|format(item.rsi_14) if item.rsi_14 else 'N/A' }}</div>
                </a>
                {% else %}
                <div class="no-data-message">No heatmap data available</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- MACD Heatmap -->
    <div class="tech-section heatmap-section">
        <div class="section-title">üìâ MACD Heatmap</div>
        
        <div class="heatmap-container" id="macd-heatmap">
            <div class="heatmap-legend">
                <div class="legend-item active" data-filter="macd-bullish" onclick="toggleHeatmapFilter('macd-heatmap', 'macd-bullish', this)">
                    <span class="legend-color macd-bullish"></span>
                    <span>MACD > Signal (Bullish)</span>
                    <span class="legend-count" id="macd-bullish-count">0</span>
                </div>
                <div class="legend-item active" data-filter="macd-neutral" onclick="toggleHeatmapFilter('macd-heatmap', 'macd-neutral', this)">
                    <span class="legend-color macd-neutral"></span>
                    <span>Neutral</span>
                    <span class="legend-count" id="macd-neutral-count">0</span>
                </div>
                <div class="legend-item active" data-filter="macd-bearish" onclick="toggleHeatmapFilter('macd-heatmap', 'macd-bearish', this)">
                    <span class="legend-color macd-bearish"></span>
                    <span>MACD < Signal (Bearish)</span>
                    <span class="legend-count" id="macd-bearish-count">0</span>
                </div>
            </div>
            
            <div class="heatmap-grid">
                {% for item in tech_data.heatmap %}
                {% set macd_class = 'macd-bullish' if item.macd and item.macd_signal and item.macd > item.macd_signal else ('macd-bearish' if item.macd and item.macd_signal and item.macd < item.macd_signal else 'macd-neutral') %}
                <a href="/stock/{{ item.ticker }}" class="heatmap-cell {{ macd_class }}" data-category="{{ macd_class }}" title="{{ item.ticker }}: MACD={{ '%.2f'|format(item.macd) if item.macd else 'N/A' }}">
                    <div class="ticker">{{ item.ticker }}</div>
                    <div class="value">{{ "%.1f"|format(item.macd) if item.macd else 'N/A' }}</div>
                </a>
                {% else %}
                <div class="no-data-message">No heatmap data available</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- SMA Heatmap -->
    <div class="tech-section heatmap-section">
        <div class="section-title">üìà SMA Heatmap</div>
        
        <div class="heatmap-container" id="sma-heatmap">
            <div class="heatmap-legend">
                <div class="legend-item active" data-filter="sma-bullish" onclick="toggleHeatmapFilter('sma-heatmap', 'sma-bullish', this)">
                    <span class="legend-color sma-bullish"></span>
                    <span>Above 200 SMA (Bullish)</span>
                    <span class="legend-count" id="sma-bullish-count">0</span>
                </div>
                <div class="legend-item active" data-filter="sma-neutral" onclick="toggleHeatmapFilter('sma-heatmap', 'sma-neutral', this)">
                    <span class="legend-color sma-neutral"></span>
                    <span>No Data</span>
                    <span class="legend-count" id="sma-neutral-count">0</span>
                </div>
                <div class="legend-item active" data-filter="sma-bearish" onclick="toggleHeatmapFilter('sma-heatmap', 'sma-bearish', this)">
                    <span class="legend-color sma-bearish"></span>
                    <span>Below 200 SMA (Bearish)</span>
                    <span class="legend-count" id="sma-bearish-count">0</span>
                </div>
            </div>
            
            <div class="heatmap-grid">
                {% for item in tech_data.heatmap %}
                {% set sma_class = 'sma-bullish' if item.above_200_sma else ('sma-bearish' if item.below_200_sma else 'sma-neutral') %}
                <a href="/stock/{{ item.ticker }}" class="heatmap-cell {{ sma_class }}" data-category="{{ sma_class }}" title="{{ item.ticker }}: {{ '%+.1f'|format(item.dist_from_200sma_pct) if item.dist_from_200sma_pct else 'N/A' }}% from 200 SMA">
                    <div class="ticker">{{ item.ticker }}</div>
                    <div class="value">{{ "%+.0f"|format(item.dist_from_200sma_pct) if item.dist_from_200sma_pct else 'N/A' }}%</div>
                </a>
                {% else %}
                <div class="no-data-message">No heatmap data available</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ADX Heatmap -->
    <div class="tech-section heatmap-section">
        <div class="section-title">üí™ ADX Heatmap (Trend Strength)</div>
        
        <div class="heatmap-container" id="adx-heatmap">
            <div class="heatmap-legend">
                <div class="legend-item active" data-filter="adx-strong" onclick="toggleHeatmapFilter('adx-heatmap', 'adx-strong', this)">
                    <span class="legend-color adx-strong"></span>
                    <span>ADX > 25 (Strong Trend)</span>
                    <span class="legend-count" id="adx-strong-count">0</span>
                </div>
                <div class="legend-item active" data-filter="adx-neutral" onclick="toggleHeatmapFilter('adx-heatmap', 'adx-neutral', this)">
                    <span class="legend-color adx-neutral"></span>
                    <span>No Data</span>
                    <span class="legend-count" id="adx-neutral-count">0</span>
                </div>
                <div class="legend-item active" data-filter="adx-weak" onclick="toggleHeatmapFilter('adx-heatmap', 'adx-weak', this)">
                    <span class="legend-color adx-weak"></span>
                    <span>ADX < 25 (Weak/No Trend)</span>
                    <span class="legend-count" id="adx-weak-count">0</span>
                </div>
            </div>
            
            <div class="heatmap-grid">
                {% for item in tech_data.heatmap %}
                {% set adx_class = 'adx-strong' if item.adx_14 and item.adx_14 > 25 else ('adx-weak' if item.adx_14 else 'adx-neutral') %}
                <a href="/stock/{{ item.ticker }}" class="heatmap-cell {{ adx_class }}" data-category="{{ adx_class }}" title="{{ item.ticker }}: ADX={{ '%.1f'|format(item.adx_14) if item.adx_14 else 'N/A' }}">
                    <div class="ticker">{{ item.ticker }}</div>
                    <div class="value">{{ "%.0f"|format(item.adx_14) if item.adx_14 else 'N/A' }}</div>
                </a>
                {% else %}
                <div class="no-data-message">No heatmap data available</div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% else %}
    <div class="no-data-message">
        No Technical Screener data available for the selected date.<br>
        Please run the database update to generate cache data.
    </div>
    {% endif %}

</div>

<script>
// Calculate and display counts on page load
document.addEventListener('DOMContentLoaded', function() {
    updateAllCounts();
});

function updateAllCounts() {
    // RSI counts - 6 categories
    updateCount('rsi-heatmap', 'rsi-overbought', 'rsi-overbought-count');
    updateCount('rsi-heatmap', 'rsi-strong-bullish', 'rsi-strong-bullish-count');
    updateCount('rsi-heatmap', 'rsi-mild-bullish', 'rsi-mild-bullish-count');
    updateCount('rsi-heatmap', 'rsi-mild-bearish', 'rsi-mild-bearish-count');
    updateCount('rsi-heatmap', 'rsi-strong-bearish', 'rsi-strong-bearish-count');
    updateCount('rsi-heatmap', 'rsi-oversold', 'rsi-oversold-count');
    
    // MACD counts
    updateCount('macd-heatmap', 'macd-bullish', 'macd-bullish-count');
    updateCount('macd-heatmap', 'macd-neutral', 'macd-neutral-count');
    updateCount('macd-heatmap', 'macd-bearish', 'macd-bearish-count');
    
    // SMA counts
    updateCount('sma-heatmap', 'sma-bullish', 'sma-bullish-count');
    updateCount('sma-heatmap', 'sma-neutral', 'sma-neutral-count');
    updateCount('sma-heatmap', 'sma-bearish', 'sma-bearish-count');
    
    // ADX counts
    updateCount('adx-heatmap', 'adx-strong', 'adx-strong-count');
    updateCount('adx-heatmap', 'adx-neutral', 'adx-neutral-count');
    updateCount('adx-heatmap', 'adx-weak', 'adx-weak-count');
}

function updateCount(containerId, category, countId) {
    var container = document.getElementById(containerId);
    if (!container) return;
    var cells = container.querySelectorAll('.heatmap-cell[data-category="' + category + '"]');
    var countEl = document.getElementById(countId);
    if (countEl) {
        countEl.textContent = cells.length;
    }
}

function toggleHeatmapFilter(containerId, category, legendItem) {
    var container = document.getElementById(containerId);
    if (!container) return;
    var cells = container.querySelectorAll('.heatmap-cell[data-category="' + category + '"]');
    
    // Toggle active state on legend item
    legendItem.classList.toggle('active');
    
    // Show or hide cells
    var isActive = legendItem.classList.contains('active');
    cells.forEach(function(cell) {
        cell.style.display = isActive ? '' : 'none';
    });
}
</script>

{% endblock %}

{% extends "base.html" %}

{% block title %}{{ symbol }} - Fundamental Analysis{% endblock %}

{% macro render_financial_table(data, title, limit=13) %}
<div class="fund-section">
    <h2 class="fund-section-title">{{ title }}</h2>
    {% if data %}
    <div class="fund-table-wrapper">
        <table class="fund-data-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    {% set dates = data.keys()|sort(reverse=True)|list %}
                    {% for date in dates %}
                    {% if loop.index <= limit %} <th>{{ date }}</th>
                        {% endif %}
                        {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% set all_metrics = {} %}
                {% for date, items in data.items() %}
                {% for item in items %}
                {% for key, value in item.items() %}
                {% if not (value is string and ('/' in value or value.startswith('http'))) %}
                {% if key not in all_metrics %}
                {% set _ = all_metrics.update({key: True}) %}
                {% endif %}
                {% endif %}
                {% endfor %}
                {% endfor %}
                {% endfor %}

                {% for metric in all_metrics.keys() %}
                <tr>
                    <td>{{ metric }}</td>
                    {% set dates = data.keys()|sort(reverse=True)|list %}
                    {% for date in dates %}
                    {% if loop.index <= limit %} <td>
                        {% set value = namespace(found='-') %}
                        {% for item in data[date] %}
                        {% if metric in item %}
                        {% set val = item[metric] %}
                        {% if not (val is string and ('/' in val or val.startswith('http'))) %}
                        {% set value.found = val %}
                        {% endif %}
                        {% endif %}
                        {% endfor %}
                        {% if value.found != '-' %}
                        {% if value.found is number %}
                        {% if '%' in metric %}
                        {{ "%.2f"|format(value.found * 100) }}%
                        {% else %}
                        {{ "%.2f"|format(value.found) }}
                        {% endif %}
                        {% else %}
                        {{ value.found }}
                        {% endif %}
                        {% else %}
                        -
                        {% endif %}
                        </td>
                        {% endif %}
                        {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="fund-text-secondary">No data available</p>
    {% endif %}
</div>
{% endmacro %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/fundamental.css') }}">
{% endblock %}

{% block content %}

<!-- Navigation Tabs -->
<div class="fund-nav-tabs">
    <div class="fund-nav-tabs-inner">
        <span class="fund-company-tab">{{ symbol }}</span>
        <a href="#chart" class="fund-nav-tab ">Chart</a>
        <a href="#quarters" class="fund-nav-tab">Quarters</a>
        <a href="#profit-loss" class="fund-nav-tab">Profit & Loss</a>
        <a href="#balance-sheet" class="fund-nav-tab">Balance Sheet</a>
        <a href="#cash-flow" class="fund-nav-tab">Cash Flow</a>
        <a href="#ratios" class="fund-nav-tab">Ratios</a>
        <a href="#shareholding" class="fund-nav-tab">Shareholding</a>
    </div>
</div>

<!-- Main Content -->
<div class="fundamental-container">

    <!-- Back to Stock Detail -->
    <a href="/stock/{{ symbol }}" class="back-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
        Back to Option Chain
    </a>

    <!-- No Data Warning -->
    {% if not quarterly and not pnl and not balance_sheet %}
    <div
        style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 16px 24px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#856404" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        <div>
            <strong style="color: #856404;">No Fundamental Data Available for {{ symbol }}</strong>
            <p style="margin: 4px 0 0 0; color: #856404; font-size: 14px;">
                Fundamental data is available for: {{ available_stocks|join(', ') }}
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Summary Section -->
    <div id="summary" class="fund-content-section">
        <div class="fund-summary-box">
            <div class="fund-metrics-container">
                <!-- Main Metrics -->
                <div class="fund-metrics-main">
                    <div class="fund-company-heading">
                        <h1 class="fund-company-title">{{ symbol }}</h1>

                        <div class="fund-company-price">
                            <span class="fund-price-main">₹ {{ "{:,.2f}".format(metrics.current_price if
                                metrics.current_price else 0) }}</span>
                            <span
                                class="fund-price-change {% if metrics.price_change >= 0 %}positive{% else %}negative{% endif %}">
                                {% if metrics.price_change >= 0 %}+{% endif %}{{ "%.2f"|format(metrics.price_change if
                                metrics.price_change else 0) }}%
                            </span>
                            <span class="fund-price-date">Latest close price</span>
                        </div>

                        <div class="fund-company-meta">
                            <span>BSE: {{ symbol }}</span>
                        </div>
                    </div>

                    <div class="fund-metrics-grid">
                        <!-- Column 1 -->
                        <div>
                            {% if metrics.market_cap and metrics.market_cap > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Market Cap</span>
                                <span class="fund-metric-value">₹ {{ "{:,.0f}".format(metrics.market_cap) }} Cr.</span>
                            </div>
                            {% endif %}

                            {% if metrics.stock_pe and metrics.stock_pe > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Stock P/E</span>
                                <span class="fund-metric-value">{{ "%.1f"|format(metrics.stock_pe) }}</span>
                            </div>
                            {% endif %}

                            {% if metrics.roce and metrics.roce > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">ROCE</span>
                                <span class="fund-metric-value">{{ "%.2f"|format(metrics.roce * 100) }} %</span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Column 2 -->
                        <div>
                            {% if metrics.current_price and metrics.current_price > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Current Price</span>
                                <span class="fund-metric-value large">₹ {{ "{:,.2f}".format(metrics.current_price)
                                    }}</span>
                            </div>
                            {% endif %}

                            {% if metrics.book_value and metrics.book_value > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Book Value</span>
                                <span class="fund-metric-value">₹ {{ "%.0f"|format(metrics.book_value) }}</span>
                            </div>
                            {% endif %}

                            {% if metrics.roe and metrics.roe > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">ROE</span>
                                <span class="fund-metric-value">{{ "%.2f"|format(metrics.roe * 100) }} %</span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Column 3 -->
                        <div>
                            {% if (metrics.high_52w and metrics.high_52w > 0) or (metrics.low_52w and metrics.low_52w >
                            0) %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">High / Low</span>
                                <span class="fund-metric-value">₹ {{ "%.0f"|format(metrics.high_52w if metrics.high_52w
                                    else 0) }} / {{ "%.0f"|format(metrics.low_52w if metrics.low_52w else 0) }}</span>
                            </div>
                            {% endif %}

                            {% if metrics.dividend_yield and metrics.dividend_yield > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Dividend Yield</span>
                                <span class="fund-metric-value">{{ "%.2f"|format(metrics.dividend_yield) }} %</span>
                            </div>
                            {% endif %}

                            {% if metrics.face_value and metrics.face_value > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Face Value</span>
                                <span class="fund-metric-value">₹ {{ "%.1f"|format(metrics.face_value) }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- About Section -->
                <div class="fund-about-section">
                    <h3>ABOUT</h3>
                    <p>
                        {{ symbol }} is a publicly listed company on BSE.
                        Financial data and analysis tools provided for comprehensive stock evaluation.
                    </p>
                    <div class="fund-key-points">
                        <h3>KEY POINTS</h3>
                        <ul>
                            {% if metrics.current_price and metrics.current_price > 0 %}
                            <li><strong>Current Price:</strong> ₹{{ "{:,.2f}".format(metrics.current_price) }}</li>
                            {% endif %}
                            {% if (metrics.low_52w and metrics.low_52w > 0) or (metrics.high_52w and metrics.high_52w >
                            0) %}
                            <li><strong>52W Range:</strong> ₹{{ "%.0f"|format(metrics.low_52w if metrics.low_52w else 0)
                                }} - ₹{{ "%.0f"|format(metrics.high_52w if metrics.high_52w else 0) }}</li>
                            {% endif %}
                            {% if metrics.market_cap and metrics.market_cap > 0 %}
                            <li><strong>Market Cap:</strong> ₹{{ "{:,.0f}".format(metrics.market_cap) }} Cr</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div id="chart" class="fund-content-section">
        <div class="fund-section">
            <div class="fund-chart-header">
                <div class="fund-chart-controls">
                    <button class="fund-chart-period-btn" data-period="1M">1M</button>
                    <button class="fund-chart-period-btn" data-period="6M">6M</button>
                    <button class="fund-chart-period-btn" data-period="1Y">1Yr</button>
                    <button class="fund-chart-period-btn" data-period="3Y">3Yr</button>
                    <button class="fund-chart-period-btn active" data-period="5Y">5Yr</button>
                    <button class="fund-chart-period-btn" data-period="10Y">10Yr</button>
                    <button class="fund-chart-period-btn" data-period="MAX">Max</button>
                </div>
                <div class="fund-chart-options">
                    <button class="fund-chart-option-btn active">Price</button>
                </div>
            </div>
            <div class="fund-chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <div class="fund-chart-footer">
                <label class="fund-chart-checkbox">
                    <input type="checkbox" checked>
                    <span>Price</span>
                </label>
                <label class="fund-chart-checkbox">
                    <input type="checkbox" checked>
                    <span>Volume</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Quarterly Results Section -->
    <div id="quarters" class="fund-content-section">
        {{ render_financial_table(quarterly, "Quarterly Results", 13) }}
    </div>

    <!-- Profit & Loss Section -->
    <div id="profit-loss" class="fund-content-section">
        {{ render_financial_table(pnl, "Profit & Loss Statement", 13) }}
    </div>

    <!-- Balance Sheet Section -->
    <div id="balance-sheet" class="fund-content-section">
        {{ render_financial_table(balance_sheet, "Balance Sheet", 13) }}
    </div>

    <!-- Cash Flow Section -->
    <div id="cash-flow" class="fund-content-section">
        {{ render_financial_table(cashflow, "Cash Flow Statement", 13) }}
    </div>

    <!-- Ratios Section -->
    <div id="ratios" class="fund-content-section">
        {{ render_financial_table(ratios, "Financial Ratios", 13) }}
    </div>

    <!-- Shareholding Section -->
    <div id="shareholding" class="fund-content-section">
        {{ render_financial_table(shareholding, "Shareholding Pattern", 13) }}
    </div>

</div>
{% endblock %}

{% block page_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    // Price chart data
    const chartData = {{ chart_data| tojson }};
    let chartInstance = null;

    // Filter data by time period
    function filterDataByPeriod(data, period) {
        if (!data || data.length === 0) return data;

        const now = new Date();
        let cutoffDate;

        switch (period) {
            case '1M':
                cutoffDate = new Date(now.setMonth(now.getMonth() - 1));
                break;
            case '6M':
                cutoffDate = new Date(now.setMonth(now.getMonth() - 6));
                break;
            case '1Y':
                cutoffDate = new Date(now.setFullYear(now.getFullYear() - 1));
                break;
            case '3Y':
                cutoffDate = new Date(now.setFullYear(now.getFullYear() - 3));
                break;
            case '5Y':
                cutoffDate = new Date(now.setFullYear(now.getFullYear() - 5));
                break;
            case '10Y':
                cutoffDate = new Date(now.setFullYear(now.getFullYear() - 10));
                break;
            case 'MAX':
                return data;
            default:
                return data;
        }

        return data.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate >= cutoffDate;
        });
    }

    // Render chart with current settings
    function updateChart(period = '5Y') {
        if (!chartData || chartData.length === 0) return;

        const filteredData = filterDataByPeriod(chartData, period);
        const dates = filteredData.map(d => d.date);
        const prices = filteredData.map(d => parseFloat(d.value));
        const volumes = prices.map(() => Math.random() * 1000000 + 500000);

        // Get checkbox states
        const checkboxes = document.querySelectorAll('.fund-chart-checkbox input[type="checkbox"]');
        const showPrice = checkboxes[0] ? checkboxes[0].checked : true;
        const showVolume = checkboxes[1] ? checkboxes[1].checked : true;

        const datasets = [];

        // Add volume bars if enabled
        if (showVolume) {
            datasets.push({
                label: 'Volume',
                type: 'bar',
                data: volumes,
                backgroundColor: 'rgba(147, 197, 253, 0.4)',
                borderColor: 'rgba(147, 197, 253, 0.8)',
                borderWidth: 0,
                yAxisID: 'y1',
                order: 2,
                barThickness: 'flex',
                maxBarThickness: 4
            });
        }

        // Add price line if enabled
        if (showPrice) {
            datasets.push({
                label: 'Price',
                type: 'line',
                data: prices,
                borderColor: '#6366f1',
                backgroundColor: 'transparent',
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 4,
                tension: 0.1,
                fill: false,
                yAxisID: 'y',
                order: 1
            });
        }

        const ctx = document.getElementById('priceChart');
        if (!ctx) return;

        // Destroy existing chart
        if (chartInstance) {
            chartInstance.destroy();
        }

        // Create new chart
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            title: function (tooltipItems) {
                                return tooltipItems[0].label;
                            },
                            label: function (context) {
                                if (context.dataset.label === 'Price') {
                                    return 'Price: ₹' + context.parsed.y.toFixed(2);
                                } else {
                                    return 'Volume: ' + Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxTicksLimit: 12,
                            autoSkip: true,
                            color: '#9ca3af'
                        }
                    },
                    y: {
                        display: showPrice,
                        position: 'right',
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9ca3af',
                            callback: function (value) {
                                return '₹' + value.toLocaleString();
                            }
                        },
                        title: {
                            display: true,
                            text: 'Price',
                            color: '#6b7280',
                            font: {
                                size: 11
                            }
                        }
                    },
                    y1: {
                        display: showVolume,
                        position: 'left',
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#9ca3af',
                            callback: function (value) {
                                if (value >= 1000000) {
                                    return (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return (value / 1000).toFixed(0) + 'k';
                                }
                                return value;
                            }
                        },
                        title: {
                            display: true,
                            text: 'Volume',
                            color: '#6b7280',
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    }

    // Initialize chart when page loads
    document.addEventListener('DOMContentLoaded', function () {
        if (chartData && chartData.length > 0) {
            updateChart('5Y');

            // Add event listeners to period buttons
            document.querySelectorAll('.fund-chart-period-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    // Remove active class from all buttons
                    document.querySelectorAll('.fund-chart-period-btn').forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    // Update chart with selected period
                    const period = this.getAttribute('data-period');
                    updateChart(period);
                });
            });

            // Add event listeners to checkboxes
            document.querySelectorAll('.fund-chart-checkbox input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    // Get current active period
                    const activeBtn = document.querySelector('.fund-chart-period-btn.active');
                    const period = activeBtn ? activeBtn.getAttribute('data-period') : '5Y';
                    updateChart(period);
                });
            });
        }
    });

    // Tab navigation - scroll-based active state
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('.fund-nav-tab');
        const sections = document.querySelectorAll('.fund-content-section[id]');
        let isClickScrolling = false; // Flag to prevent scroll handler during click navigation

        // Click handler for tabs - use smooth scroll and lock scroll updates
        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default anchor jump

                const targetId = tab.getAttribute('href');
                const targetSection = document.querySelector(targetId);

                if (targetSection) {
                    // Set active state immediately
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Lock scroll updates during navigation
                    isClickScrolling = true;

                    // Smooth scroll to section
                    const navHeight = 80; // Height of sticky nav
                    const targetPosition = targetSection.offsetTop - navHeight;

                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });

                    // Unlock scroll updates after animation completes
                    setTimeout(() => {
                        isClickScrolling = false;
                    }, 800);
                }
            });
        });

        // Scroll handler for active tab highlighting
        function updateActiveTab() {
            // Don't update if user just clicked a tab
            if (isClickScrolling) return;

            let current = '';
            const scrollPos = window.scrollY;
            const navHeight = 100;

            sections.forEach(section => {
                const sectionTop = section.offsetTop - navHeight - 50;
                const sectionBottom = sectionTop + section.offsetHeight;

                if (scrollPos >= sectionTop && scrollPos < sectionBottom) {
                    current = section.getAttribute('id');
                }
            });

            // If no section matched (at top of page), default to chart
            if (!current && scrollPos < 300) {
                current = 'chart';
            }

            // Only update if we found a valid section
            if (current) {
                tabs.forEach(tab => {
                    tab.classList.remove('active');
                    const href = tab.getAttribute('href');
                    if (href === '#' + current) {
                        tab.classList.add('active');
                    }
                });
            }
        }

        // Initial update and add scroll listener with throttle
        updateActiveTab();

        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateActiveTab, 50);
        });
    });

</script>
{% endblock %}

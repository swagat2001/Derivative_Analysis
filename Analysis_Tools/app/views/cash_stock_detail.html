{% extends "base.html" %}
{% block title %}{{ ticker }} – Stock Details{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stock_detail.css') }}">

<style>
  .cash-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px 24px 60px;
  }

  /*  Header  */
  .cash-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 24px;
  }

  .cash-title-block {
    display: flex;
    align-items: baseline;
    gap: 14px;
    flex-wrap: wrap;
  }

  .cash-ticker {
    font-size: 28px;
    font-weight: 800;
    color: #1f2937;
    letter-spacing: -0.5px;
  }

  .cash-badge {
    font-size: 11px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 20px;
    background: #f3f4f6;
    color: #6b7280;
    border: 1px solid #e5e7eb;
  }

  .cash-price {
    font-size: 32px;
    font-weight: 700;
    color: #111827;
  }

  .cash-chg {
    font-size: 15px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 8px;
    margin-left: 8px;
  }

  .cash-chg.up {
    background: #dcfce7;
    color: #15803d;
  }

  .cash-chg.down {
    background: #fee2e2;
    color: #dc2626;
  }

  .cash-chg.flat {
    background: #f3f4f6;
    color: #6b7280;
  }

  .cash-header-actions {
    display: flex;
    gap: 10px;
  }

  .cash-header-actions a {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
    border: 1px solid #e5e7eb;
    color: #374151;
    background: white;
    transition: all 0.15s;
  }

  .cash-header-actions a:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }

  /*  Stats Grid  */
  .stats-grid {
    display: flex;
    gap: 10px;
    margin-bottom: 24px;
    overflow-x: auto;
    scrollbar-width: none;
  }

  .stats-grid::-webkit-scrollbar {
    display: none;
  }

  .stat-card {
    flex: 1 1 0;
    min-width: 120px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 12px 10px;
    text-align: center;
  }

  .stat-card .s-label {
    font-size: 11px;
    color: #9ca3af;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
  }

  .stat-card .s-value {
    font-size: 18px;
    font-weight: 700;
    color: #111827;
  }

  .stat-card .s-sub {
    font-size: 11px;
    color: #6b7280;
    margin-top: 2px;
  }

  /*  Main Grid  */
  .cash-main-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 20px;
    margin-bottom: 24px;
  }

  @media (max-width: 960px) {
    .cash-main-grid {
      grid-template-columns: 1fr;
    }
  }

  /*  Cards  */
  .c-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
  }

  .c-card-title {
    font-size: 14px;
    font-weight: 700;
    color: #374151;
    margin: 0 0 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /*  Chart  */
  #cashPriceChart {
    width: 100%;
    height: 320px;
  }

  /*  Tech grid  */
  .tech-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .tech-item {
    padding: 10px 12px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #f3f4f6;
  }

  .tech-item .t-label {
    font-size: 11px;
    color: #9ca3af;
    font-weight: 500;
    margin-bottom: 4px;
  }

  .tech-item .t-value {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
  }

  .tech-item .t-sub {
    font-size: 11px;
    color: #6b7280;
    margin-top: 2px;
  }

  /*  RSI bar  */
  .rsi-track {
    height: 6px;
    border-radius: 3px;
    position: relative;
    background: linear-gradient(to right, #3b82f6 0%, #22c55e 25%, #22c55e 75%, #ef4444 100%);
  }

  .rsi-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #1f2937;
    border: 2px solid white;
    position: absolute;
    top: -3px;
    transform: translateX(-50%);
  }

  /*  SMA badges  */
  .sma-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 8px;
  }

  .sma-badge {
    font-size: 12px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    border: 1px solid;
  }

  .sma-badge.bull {
    background: #dcfce7;
    color: #15803d;
    border-color: #bbf7d0;
  }

  .sma-badge.bear {
    background: #fee2e2;
    color: #dc2626;
    border-color: #fecaca;
  }

  /*  Pivot table  */
  .pivot-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .pivot-table th {
    font-size: 11px;
    color: #9ca3af;
    font-weight: 600;
    text-align: left;
    padding: 4px 8px;
    border-bottom: 1px solid #f3f4f6;
  }

  .pivot-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #f9fafb;
  }

  .pivot-table tr:last-child td {
    border-bottom: none;
  }

  .pv-r {
    color: #dc2626;
    font-weight: 600;
  }

  .pv-s {
    color: #16a34a;
    font-weight: 600;
  }

  /*  Scanner hits  */
  .scanner-section {
    margin-bottom: 24px;
  }

  .scanner-title {
    font-size: 15px;
    font-weight: 700;
    color: #374151;
    margin: 0 0 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .scanner-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .scanner-hit {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    border-radius: 10px;
    border: 1px solid;
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.15s;
  }

  .scanner-hit:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .scanner-hit.bullish {
    background: #dcfce7;
    color: #15803d;
    border-color: #bbf7d0;
  }

  .scanner-hit.bearish {
    background: #fee2e2;
    color: #dc2626;
    border-color: #fecaca;
  }

  .scanner-hit.neutral {
    background: #fef9c3;
    color: #854d0e;
    border-color: #fde68a;
  }

  .scanner-hit .sh-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .scanner-hit.bullish .sh-dot {
    background: #16a34a;
  }

  .scanner-hit.bearish .sh-dot {
    background: #dc2626;
  }

  .scanner-hit.neutral .sh-dot {
    background: #d97706;
  }

  .no-scanner {
    color: #9ca3af;
    font-size: 13px;
    font-style: italic;
    padding: 12px 0;
  }

  /*  No data  */
  .no-data-state {
    text-align: center;
    padding: 80px 20px;
    color: #9ca3af;
  }

  .no-data-state h3 {
    font-size: 18px;
    font-weight: 600;
    color: #6b7280;
    margin: 0 0 8px;
  }

  .clr-up {
    color: #16a34a !important;
  }

  .clr-down {
    color: #dc2626 !important;
  }

  .clr-neutral {
    color: #111827 !important;
  }

  .clr-purple {
    color: #7c3aed !important;
  }
</style>

<div class="cash-page">

  {# HEADER #}
  <div class="cash-header">
    <div class="cash-title-block">
      <span class="cash-ticker">{{ ticker }}</span>
      <span class="cash-badge">Cash / Equity</span>
      {% set chg = cash_info.get('change_pct') | float %}
      <span class="cash-price">
        {% if cash_info.get('price') %}₹{{ '{:,.2f}'.format(cash_info.price | float) }}{% else %}—{% endif %}
      </span>
      <span class="cash-chg {{ 'up' if chg > 0 else ('down' if chg < 0 else 'flat') }}">
        {{ '+' if chg > 0 else '' }}{{ '{:.2f}'.format(chg) }}%
      </span>
    </div>
    <div class="cash-header-actions">
      <a href="/stock/{{ ticker }}/fundamental"> Fundamentals</a>
      <a href="/scanner/technical-indicators/"> Screeners</a>
    </div>
  </div>

  {# SCANNER APPEARANCES #}
  <div class="scanner-section">
    <div class="scanner-title">
      Scanner Appearances
      <span style="font-size:12px;font-weight:400;color:#9ca3af;">— active signals for {{ ticker }}</span>
    </div>
    {% if scanner_hits %}
    <div class="scanner-grid">
      {% for hit in scanner_hits %}
      <a href="{{ hit.url }}" class="scanner-hit {{ hit.sentiment }}">
        <span class="sh-dot"></span>{{ hit.label }}
      </a>
      {% endfor %}
    </div>
    {% else %}
    <p class="no-scanner">{{ ticker }} does not appear in any active scanner on the latest date.</p>
    {% endif %}
  </div>

  {% if cash_info.get('has_technical') or cash_info.get('ohlcv') %}

  {# STATS ROW #}
  <div class="stats-grid">
    <div class="stat-card">
      <div class="s-label">Price</div>
      <div class="s-value">{% if cash_info.get('price') %}₹{{ '{:,.2f}'.format(cash_info.price | float) }}{% else %}—{%
        endif %}</div>
      {% set price_chg_cls = 'clr-up' if chg >= 0 else 'clr-down' %}
      <div class="s-sub"><span class="{{ price_chg_cls }}">{{ '+' if chg >= 0 else '' }}{{
          '{:.2f}'.format(chg) }}%</span></div>
    </div>

    <div class="stat-card">
      <div class="s-label">Volume</div>
      {% set vol = cash_info.get('volume') | int %}
      <div class="s-value">
        {% if vol >= 10000000 %}{{ '{:.2f}'.format(vol / 10000000) }} Cr
        {% elif vol >= 100000 %}{{ '{:.2f}'.format(vol / 100000) }} L
        {% elif vol > 0 %}{{ '{:,}'.format(vol) }}
        {% else %}—{% endif %}
      </div>
    </div>

    {% if cash_info.get('week52_high') %}
    <div class="stat-card">
      <div class="s-label">52W High</div>
      <div class="s-value">₹{{ '{:,.2f}'.format(cash_info.week52_high | float) }}</div>
    </div>
    {% endif %}

    {% if cash_info.get('week52_low') %}
    <div class="stat-card">
      <div class="s-label">52W Low</div>
      <div class="s-value">₹{{ '{:,.2f}'.format(cash_info.week52_low | float) }}</div>
    </div>
    {% endif %}

    {% if cash_info.get('rsi_14') %}
    {% set r = cash_info.get('rsi_14') | float %}
    {% set rsi_cls = 'clr-down' if r > 75 else ('clr-up' if r < 25 else 'clr-neutral' ) %} <div class="stat-card">
      <div class="s-label">RSI (14)</div>
      <div class="s-value {{ rsi_cls }}">{{ '{:.1f}'.format(r) }}</div>
      <div class="s-sub">{{ 'Overbought' if r > 75 else ('Oversold' if r < 25 else 'Neutral' ) }}</div>
      </div>
      {% endif %}

      {% if cash_info.get('adx_14') %}
      <div class="stat-card">
        <div class="s-label">ADX (14)</div>
        <div class="s-value">{{ '{:.1f}'.format(cash_info.adx_14 | float) }}</div>
        <div class="s-sub">{{ 'Strong Trend' if cash_info.adx_14|float > 25 else 'Weak Trend' }}</div>
      </div>
      {% endif %}

      {% if cash_info.get('macd') is not none %}
      {% set macd_val = cash_info.get('macd', 0) | float %}
      {% set macd_cls = 'clr-up' if macd_val > 0 else 'clr-down' %}
      <div class="stat-card">
        <div class="s-label">MACD</div>
        <div class="s-value {{ macd_cls }}">{{
          '{:.2f}'.format(cash_info.macd | float) }}</div>
        <div class="s-sub">Signal: {{ '{:.2f}'.format(cash_info.get('macd_signal',0) | float) }}</div>
      </div>
      {% endif %}

      {% if cash_info.get('bb_width') %}
      <div class="stat-card">
        <div class="s-label">BB Width</div>
        <div class="s-value">{{ '{:.2f}'.format(cash_info.bb_width | float) }}%</div>
        <div class="s-sub">{{ 'Squeeze!' if cash_info.bb_width|float < 5 else 'Normal' }}</div>
        </div>
        {% endif %}

        {% if cash_info.get('momentum_score') %}
        {% set momentum_val = cash_info.momentum_score | float %}
        {% set momentum_cls = 'clr-up' if momentum_val > 0 else 'clr-down' %}
        <div class="stat-card">
          <div class="s-label">Momentum</div>
          <div class="s-value {{ momentum_cls }}">{{
            '{:.1f}'.format(momentum_val) }}</div>
        </div>
        {% endif %}
      </div>

      {# MAIN GRID #}
      <div class="cash-main-grid">

        {# Price Chart #}
        <div class="c-card">
          <div class="c-card-title"> Price History (Last 90 Days)</div>
          {% if cash_info.get('ohlcv') %}
          <div id="cashPriceChart"></div>
          {% else %}
          <p style="color:#9ca3af;font-size:13px;text-align:center;padding:60px 0;">No price history available</p>
          {% endif %}
        </div>

        {# Right panel #}
        <div style="display:flex;flex-direction:column;gap:16px;">

          {# RSI Gauge #}
          {% if cash_info.get('rsi_14') %}
          {% set rsi_val = cash_info.get('rsi_14') | float %}
          {% set rsi_gauge_cls = 'clr-down' if rsi_val > 75 else ('clr-up' if rsi_val < 25 else 'clr-neutral' ) %} <div
            class="c-card">
            <div class="c-card-title"> RSI (14)</div>
            <div class="rsi-highlight {{ rsi_gauge_cls }}" style="font-size:36px;font-weight:800;text-align:center;">
              {{ '{:.1f}'.format(rsi_val) }}
            </div>
            <div style="text-align:center;font-size:12px;color:#9ca3af;margin:4px 0 12px;">
              {{ 'Overbought' if rsi_val > 75 else ('Oversold' if rsi_val < 25 else 'Neutral Zone' ) }} </div>
                <div class="rsi-track">
                  <div class="rsi-dot" id="rsiDot"></div>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:10px;color:#9ca3af;margin-top:4px;">
                  <span>0 Oversold</span><span>50</span><span>Overbought 100</span>
                </div>
            </div>
            {% endif %}

            {# Moving Averages #}
            {% if cash_info.get('sma_50') or cash_info.get('sma_200') %}
            <div class="c-card">
              <div class="c-card-title"> Moving Averages</div>
              <div class="tech-grid">
                {% if cash_info.get('sma_50') %}
                <div class="tech-item">
                  <div class="t-label">SMA 50</div>
                  <div class="t-value">₹{{ '{:,.2f}'.format(cash_info.sma_50 | float) }}</div>
                  {% if cash_info.get('dist_from_50sma_pct') %}
                  {% set d50 = cash_info.dist_from_50sma_pct | float %}
                  {% set d50_cls = 'clr-up' if d50 >= 0 else 'clr-down' %}
                  <div class="t-sub"><span class="{{ d50_cls }}">{{ '+' if d50 >= 0
                      else '' }}{{ '{:.2f}'.format(d50) }}%</span></div>
                  {% endif %}
                </div>
                {% endif %}
                {% if cash_info.get('sma_200') %}
                <div class="tech-item">
                  <div class="t-label">SMA 200</div>
                  <div class="t-value">₹{{ '{:,.2f}'.format(cash_info.sma_200 | float) }}</div>
                  {% if cash_info.get('dist_from_200sma_pct') %}
                  {% set d200 = cash_info.dist_from_200sma_pct | float %}
                  {% set d200_cls = 'clr-up' if d200 >= 0 else 'clr-down' %}
                  <div class="t-sub"><span class="{{ d200_cls }}">{{ '+' if d200 >=
                      0 else '' }}{{ '{:.2f}'.format(d200) }}%</span></div>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              <div class="sma-row">
                {% if cash_info.get('above_50_sma') %}<span class="sma-badge bull"> Above SMA50</span>{% endif %}
                {% if cash_info.get('below_50_sma') %}<span class="sma-badge bear"> Below SMA50</span>{% endif %}
                {% if cash_info.get('above_200_sma') %}<span class="sma-badge bull"> Above SMA200</span>{% endif %}
                {% if cash_info.get('below_200_sma') %}<span class="sma-badge bear"> Below SMA200</span>{% endif %}
              </div>
            </div>
            {% endif %}

        </div>
      </div>

      {# BOTTOM GRID — Pivots + Bollinger #}
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">

        {% if cash_info.get('r1') or cash_info.get('s1') %}
        <div class="c-card">
          <div class="c-card-title"> Pivot Levels</div>
          <table class="pivot-table">
            <thead>
              <tr>
                <th>Level</th>
                <th>Price</th>
                <th>Distance</th>
              </tr>
            </thead>
            <tbody>
              {% set cur = cash_info.get('price') | float %}
              {% for lbl, key, cls in
              [('R3','r3','pv-r'),('R2','r2','pv-r'),('R1','r1','pv-r'),('S1','s1','pv-s'),('S2','s2','pv-s'),('S3','s3','pv-s')]
              %}
              {% set val = cash_info.get(key) %}
              {% if val %}
              <tr>
                <td class="{{ cls }}">{{ lbl }}</td>
                <td>₹{{ '{:,.2f}'.format(val | float) }}</td>
                <td>{% if cur %}{% set diff = ((val | float) - cur) / cur * 100 %}{% set diff_cls = 'clr-up' if diff >=
                  0 else 'clr-down' %}<span class="{{ diff_cls }}">{{ '+' if diff >= 0 else '' }}{{
                    '{:.2f}'.format(diff) }}%</span>{% endif %}</td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}

        {% if cash_info.get('bb_upper') %}
        {% set price_f = cash_info.get('price') | float %}
        {% set bb_up = cash_info.get('bb_upper') | float %}
        {% set bb_mid = cash_info.get('bb_middle') | float %}
        {% set bb_lo = cash_info.get('bb_lower') | float %}
        {% set bb_rng = bb_up - bb_lo %}
        {% set bb_pos = ((price_f - bb_lo) / bb_rng * 100) if bb_rng > 0 else 50 %}
        <div class="c-card">
          <div class="c-card-title"> Bollinger Bands</div>
          <div class="tech-grid" style="margin-bottom:14px;">
            <div class="tech-item">
              <div class="t-label">Upper</div>
              <div class="t-value clr-down">₹{{ '{:,.2f}'.format(bb_up) }}</div>
            </div>
            <div class="tech-item">
              <div class="t-label">Middle</div>
              <div class="t-value clr-purple">₹{{ '{:,.2f}'.format(bb_mid) }}</div>
            </div>
            <div class="tech-item">
              <div class="t-label">Lower</div>
              <div class="t-value clr-up">₹{{ '{:,.2f}'.format(bb_lo) }}</div>
            </div>
            <div class="tech-item">
              <div class="t-label">BB Width</div>
              <div class="t-value">{{ '{:.2f}'.format(cash_info.get('bb_width') | float) }}%</div>
            </div>
          </div>
          <div style="font-size:11px;color:#9ca3af;margin-bottom:4px;">Price position within bands</div>
          <div style="background:#f3f4f6;border-radius:6px;height:12px;overflow:hidden;">
            <div id="bbProgressBar" data-bb-pos="{{ bb_pos }}"
              style="height:100%;background:linear-gradient(to right,#16a34a,#f59e0b,#dc2626);border-radius:6px;width:0;">
            </div>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:10px;color:#9ca3af;margin-top:3px;">
            <span>Lower</span><span>Middle</span><span>Upper</span>
          </div>
          {% if cash_info.get('bb_width', 0) | float < 5 %} <div
            style="margin-top:10px;padding:8px 12px;background:#fef9c3;border-radius:8px;font-size:12px;font-weight:600;color:#854d0e;border:1px solid #fde68a;">
            Bollinger Band Squeeze — potential breakout imminent
        </div>
        {% endif %}
      </div>
      {% endif %}

  </div>

  {% else %}
  <div class="no-data-state">
    <div style="font-size:48px;margin-bottom:16px;"></div>
    <h3>No data available for {{ ticker }}</h3>
    <p>This stock may not have been processed by the technical screener yet.<br>
      Run <code>update_all_data.py</code> to refresh the data.</p>
  </div>
  {% endif %}

</div>

<div id="stockData" style="display:none;" data-ohlcv='{{ ohlcv_json | safe }}'
  data-rsi='{{ cash_info.get("rsi_14") if cash_info.get("rsi_14") is not none else "null" }}'>
</div>

<script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
  (function () {
    const dataEl = document.getElementById('stockData');
    const OHLCV = JSON.parse(dataEl.dataset.ohlcv || '[]');
    const rawRsi = dataEl.dataset.rsi;
    const RSI_VAL = rawRsi === 'null' ? null : Number(rawRsi);

    /*  Candlestick chart  */
    if (OHLCV && OHLCV.length > 0) {
      const container = document.getElementById('cashPriceChart');
      if (container) {
        const chart = LightweightCharts.createChart(container, {
          width: container.offsetWidth,
          height: 320,
          layout: { background: { type: 'solid', color: '#ffffff' }, textColor: '#374151' },
          grid: { vertLines: { color: '#f3f4f6' }, horzLines: { color: '#f3f4f6' } },
          crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
          rightPriceScale: { borderColor: '#e5e7eb' },
          timeScale: { borderColor: '#e5e7eb', timeVisible: true },
        });

        const candleSeries = chart.addCandlestickSeries({
          upColor: '#16a34a', downColor: '#dc2626',
          borderUpColor: '#16a34a', borderDownColor: '#dc2626',
          wickUpColor: '#16a34a', wickDownColor: '#dc2626',
        });

        const volumeSeries = chart.addHistogramSeries({
          priceFormat: { type: 'volume' },
          priceScaleId: 'vol',
        });
        chart.priceScale('vol').applyOptions({ scaleMargins: { top: 0.8, bottom: 0 } });

        // Volume Moving Average (20)
        const vmaSeries = chart.addLineSeries({
          color: '#3b82f6',
          lineWidth: 2,
          priceScaleId: 'vol',
          title: 'VMA (20)',
        });

        candleSeries.setData(OHLCV.map(d => ({ time: d.date, open: d.open, high: d.high, low: d.low, close: d.close })));

        // Volume data with better visibility (higher opacity)
        volumeSeries.setData(OHLCV.map(d => ({
          time: d.date,
          value: d.volume,
          color: d.close >= d.open ? '#16a34a80' : '#dc262680'
        })));

        // Calculate VMA 20
        const vmaData = [];
        for (let i = 0; i < OHLCV.length; i++) {
          if (i >= 19) {
            let sum = 0;
            for (let j = 0; j < 20; j++) {
              sum += OHLCV[i - j].volume;
            }
            vmaData.push({ time: OHLCV[i].date, value: sum / 20 });
          }
        }
        vmaSeries.setData(vmaData);

        chart.timeScale().fitContent();

        new ResizeObserver(() => chart.applyOptions({ width: container.offsetWidth })).observe(container);
      }
    }

    if (RSI_VAL !== null) {
      const dot = document.getElementById('rsiDot');
      if (dot) dot.style.left = Math.max(0, Math.min(100, RSI_VAL)) + '%';
    }

    /* Bollinger Band Progress Bar */
    const bbBar = document.getElementById('bbProgressBar');
    if (bbBar) {
      const bbPos = Number(bbBar.dataset.bbPos);
      bbBar.style.width = Math.max(0, Math.min(100, bbPos)) + '%';
    }
  })();
</script>
{% endblock %}

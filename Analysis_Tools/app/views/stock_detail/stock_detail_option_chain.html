<!-- ==============================
     OPTION CHAIN TABLE
     ============================== -->
<div class="option-chain-section">
  <h3 class="section-title">Option Chain</h3>

  {% if data %}
  <div class="table-container">
    <p style="margin:8px 0;font-size:13px;color:#6b7280;">
       Underlying: <b>{{ underlying if underlying else 'N/A' }}</b> |
       ATM Strike: <b>{{ atm if atm else 'N/A' }}</b> |
       Futures: <b>{{ "%.2f"|format(futures_price) if futures_price else 'N/A' }}</b>
    </p>

    <table class="option-chain-table">
      <thead>
        <tr>
          <th class="ce-th">IV</th>
          <th class="ce-th">OI Chg</th>
          <th class="ce-th">OI</th>
          <th class="ce-th">Price</th>
          <th class="ce-th">Fair Price</th>
          <th class="strike-th">Strike Price</th>
          <th class="pe-th">Fair Price</th>
          <th class="pe-th">Price</th>
          <th class="pe-th">OI</th>
          <th class="pe-th">OI Chg</th>
          <th class="pe-th">IV</th>
        </tr>
      </thead>
      <tbody>
        {% set strikes = {} %}

        {# ===============================
           MAP CE / PE BY STRIKE
           =============================== #}
        {% for row in data %}
          {% if row.StrkPric and row.StrkPric > 0 %}
            {% if row.StrkPric not in strikes %}
              {% set _ = strikes.update({row.StrkPric: {}}) %}
            {% endif %}
            {% if row.OptnTp == 'CE' %}
              {% set _ = strikes[row.StrkPric].update({'ce': row}) %}
            {% elif row.OptnTp == 'PE' %}
              {% set _ = strikes[row.StrkPric].update({'pe': row}) %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {# ===============================
           RENDER TABLE ROWS
           =============================== #}
        {% for strike in strikes.keys()|list|sort %}
          {% set ce = strikes[strike].get('ce') %}
          {% set pe = strikes[strike].get('pe') %}
          {% set strike_val = strike|float %}
          {% set atm_val = atm|float %}
          {% set futures_val = futures_price|float %}

          {# Calculate Fair Price using FUTURES PRICE - Server Side #}
          {# CALL Fair Price = Max(0, Futures - Strike) #}
          {# PUT Fair Price = Max(0, Strike - Futures) #}
          {% set ce_fair_price_raw = (futures_val - strike_val) if futures_val and strike_val else None %}
          {% set pe_fair_price_raw = (strike_val - futures_val) if futures_val and strike_val else None %}

          {# Apply Max(0, value) to ensure non-negative #}
          {% set ce_fair_price = [0, ce_fair_price_raw]|max if ce_fair_price_raw is not none else None %}
          {% set pe_fair_price = [0, pe_fair_price_raw]|max if pe_fair_price_raw is not none else None %}

          <tr
            class="
              {% if strike_val == atm_val %}
                atm-row
              {% elif strike_val > atm_val %}
                otm-call
              {% elif strike_val < atm_val %}
                otm-put
              {% endif %}
            "
          >
            <!-- CE IV -->
            <td class="ce-td">
              {% if ce %}
                {% if ce.IV %}{{ "%.2f"|format(ce.IV) }}
                {% elif ce.get('iv') %}{{ "%.2f"|format(ce.get('iv')) }}
                {% else %}-{% endif %}
              {% else %}-{% endif %}
            </td>

            <!-- CE OI Change -->
            <td class="ce-td {% if ce and ce.ChngInOpnIntrst %}{% if ce.ChngInOpnIntrst > 0 %}pos{% elif ce.ChngInOpnIntrst < 0 %}neg{% endif %}{% endif %}">
              {% if ce and ce.ChngInOpnIntrst %}
                {% set v = ce.ChngInOpnIntrst %}
                {% set av = v if v > 0 else -v %}
                {% if av >= 100000 %}{{ "%.1f"|format(v/100000) }} L
                {% elif av >= 1000 %}{{ "%.1f"|format(v/1000) }} K
                {% else %}{{ v|int }}{% endif %}
              {% else %}-{% endif %}
            </td>

            <!-- CE OI -->
            <td class="ce-td">
              {% if ce and ce.OpnIntrst %}
                {% set v = ce.OpnIntrst %}
                {% if v >= 10000000 %}{{ "%.1f"|format(v/10000000) }} Cr
                {% elif v >= 100000 %}{{ "%.1f"|format(v/100000) }} L
                {% elif v >= 1000 %}{{ "%.1f"|format(v/1000) }} K
                {% else %}{{ v|int }}{% endif %}
              {% else %}-{% endif %}
            </td>

            <!-- CE Price -->
            <td class="ce-td">{% if ce and ce.ClsPric %}{{ "%.2f"|format(ce.ClsPric) }}{% else %}-{% endif %}</td>

            <!-- CE Fair Price (Max(0, Futures - Strike)) -->
            <td class="ce-td" style="font-weight: 600;">
              {% if ce_fair_price is not none %}
                {% if ce_fair_price > 0 %}
                  <span class="pos">{{ "%.2f"|format(ce_fair_price) }}</span>
                {% else %}
                  <span style="color: #9ca3af;">0.00</span>
                {% endif %}
              {% else %}-{% endif %}
            </td>

            <!-- Strike -->
            <td class="strike-td {% if strike_val == atm_val %}atm-strike{% endif %}">{{ strike|int }}</td>

            <!-- PE Fair Price (Max(0, Strike - Futures)) -->
            <td class="pe-td" style="font-weight: 600;">
              {% if pe_fair_price is not none %}
                {% if pe_fair_price > 0 %}
                  <span class="pos">{{ "%.2f"|format(pe_fair_price) }}</span>
                {% else %}
                  <span style="color: #9ca3af;">0.00</span>
                {% endif %}
              {% else %}-{% endif %}
            </td>

            <!-- PE Price -->
            <td class="pe-td">{% if pe and pe.ClsPric %}{{ "%.2f"|format(pe.ClsPric) }}{% else %}-{% endif %}</td>

            <!-- PE OI -->
            <td class="pe-td">
              {% if pe and pe.OpnIntrst %}
                {% set v = pe.OpnIntrst %}
                {% if v >= 10000000 %}{{ "%.1f"|format(v/10000000) }} Cr
                {% elif v >= 100000 %}{{ "%.1f"|format(v/100000) }} L
                {% elif v >= 1000 %}{{ "%.1f"|format(v/1000) }} K
                {% else %}{{ v|int }}{% endif %}
              {% else %}-{% endif %}
            </td>

            <!-- PE OI Change -->
            <td class="pe-td {% if pe and pe.ChngInOpnIntrst %}{% if pe.ChngInOpnIntrst > 0 %}pos{% elif pe.ChngInOpnIntrst < 0 %}neg{% endif %}{% endif %}">
              {% if pe and pe.ChngInOpnIntrst %}
                {% set v = pe.ChngInOpnIntrst %}
                {% set av = v if v > 0 else -v %}
                {% if av >= 100000 %}{{ "%.1f"|format(v/100000) }} L
                {% elif av >= 1000 %}{{ "%.1f"|format(v/1000) }} K
                {% else %}{{ v|int }}{% endif %}
              {% else %}-{% endif %}
            </td>

            <!-- PE IV -->
            <td class="pe-td">
              {% if pe %}
                {% if pe.IV %}{{ "%.2f"|format(pe.IV) }}
                {% elif pe.get('iv') %}{{ "%.2f"|format(pe.get('iv')) }}
                {% else %}-{% endif %}
              {% else %}-{% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="no-data">No data</p>
  {% endif %}
</div>

{% extends "base.html" %}

{% block title %}{{ symbol }} - Fundamental Analysis{% endblock %}

{% macro render_financial_table(data, title, limit=13) %}
<div class="fund-section">
    <h2 class="fund-section-title">{{ title }}</h2>
    {% if data %}
    <div class="fund-table-wrapper">
        <table class="fund-data-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    {% set dates = data.keys()|sort(reverse=True)|list %}
                    {% for date in dates %}
                    {% if loop.index <= limit %} <th>{{ date }}</th>
                        {% endif %}
                        {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% set all_metrics = {} %}
                {% for date, items in data.items() %}
                {% for item in items %}
                {% for key, value in item.items() %}
                {% if not (value is string and ('/' in value or value.startswith('http'))) %}
                {% if key not in all_metrics %}
                {% set _ = all_metrics.update({key: True}) %}
                {% endif %}
                {% endif %}
                {% endfor %}
                {% endfor %}
                {% endfor %}

                {% for metric in all_metrics.keys() %}
                <tr>
                    <td>{{ metric }}</td>
                    {% set dates = data.keys()|sort(reverse=True)|list %}
                    {% for date in dates %}
                    {% if loop.index <= limit %} <td>
                        {% set value = namespace(found='-') %}
                        {% for item in data[date] %}
                        {% if metric in item %}
                        {% set val = item[metric] %}
                        {% if not (val is string and ('/' in val or val.startswith('http'))) %}
                        {% set value.found = val %}
                        {% endif %}
                        {% endif %}
                        {% endfor %}
                        {% if value.found != '-' %}
                        {% if value.found is number %}
                        {% if '%' in metric %}
                        {{ "%.2f"|format(value.found * 100) }}%
                        {% else %}
                        {{ "%.2f"|format(value.found) }}
                        {% endif %}
                        {% else %}
                        {{ value.found }}
                        {% endif %}
                        {% else %}
                        -
                        {% endif %}
                        </td>
                        {% endif %}
                        {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="fund-no-data">No data available for this section</p>
    {% endif %}
</div>
{% endmacro %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/fundamental.css') }}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}

<div class="fundamental-section">
    <!-- Sticky Navigation Sidebar -->
    <nav class="fund-nav-tabs">
        <div class="fund-nav-tabs-inner">
            <div class="fund-company-tab">{{ symbol }}</div>
            <a href="#summary" class="fund-nav-tab active">Summary</a>
            <a href="#chart" class="fund-nav-tab">Chart</a>
            <a href="#quarters" class="fund-nav-tab">Quarters</a>
            <a href="#profit-loss" class="fund-nav-tab">Profit & Loss</a>
            <a href="#balance-sheet" class="fund-nav-tab">Balance Sheet</a>
            <a href="#cash-flow" class="fund-nav-tab">Cash Flow</a>
            <a href="#ratios" class="fund-nav-tab">Ratios</a>
            <a href="#shareholding" class="fund-nav-tab">Shareholding</a>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="fundamental-container">

        <!-- Back Navigation -->
        <a href="/stock/{{ symbol }}" class="back-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            Back to Option Chain
        </a>

        <!-- No Data Warning -->
        {% if not quarterly and not pnl and not balance_sheet %}
        <div class="fund-alert">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                </path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <div>
                <strong>No Fundamental Data Available for {{ symbol }}</strong>
                <p>Fundamental data is currently available for: {{ available_stocks|join(', ') }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Hero Summary Section -->
        <section id="summary" class="fund-content-section">
            <div class="fund-summary-box">
                <div class="fund-metrics-container">

                    <!-- Main Metrics Area -->
                    <div class="fund-metrics-main">
                        <div class="fund-company-heading">
                            <h1 class="fund-company-title">{{ symbol }}</h1>

                            <div class="fund-company-price">
                                <span class="fund-price-main">₹{{ "{:,.2f}".format(metrics.current_price if
                                    metrics.current_price else 0) }}</span>
                                <span
                                    class="fund-price-change {% if metrics.price_change >= 0 %}positive{% else %}negative{% endif %}">
                                    {% if metrics.price_change >= 0 %}+{% endif %}{{ "%.2f"|format(metrics.price_change
                                    if metrics.price_change else 0) }}%
                                </span>
                                <span class="fund-price-date">Latest close price</span>
                            </div>

                            <div class="fund-company-meta">
                                <span>BSE: {{ symbol }}</span>
                            </div>
                        </div>

                        <div class="fund-metrics-grid">
                            <!-- Metric Cards -->
                            {% if metrics.market_cap and metrics.market_cap > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Market Cap</span>
                                <span class="fund-metric-value">₹{{ "{:,.0f}".format(metrics.market_cap) }} Cr</span>
                            </div>
                            {% endif %}

                            {% if metrics.current_price and metrics.current_price > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Current Price</span>
                                <span class="fund-metric-value large">₹{{ "{:,.2f}".format(metrics.current_price)
                                    }}</span>
                            </div>
                            {% endif %}

                            {% if (metrics.high_52w and metrics.high_52w > 0) or (metrics.low_52w and metrics.low_52w >
                            0) %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">52W High / Low</span>
                                <span class="fund-metric-value">₹{{ "%.0f"|format(metrics.high_52w if metrics.high_52w
                                    else 0) }} / {{ "%.0f"|format(metrics.low_52w if metrics.low_52w else 0) }}</span>
                            </div>
                            {% endif %}

                            {% if metrics.stock_pe and metrics.stock_pe > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Stock P/E</span>
                                <span class="fund-metric-value">{{ "%.1f"|format(metrics.stock_pe) }}</span>
                            </div>
                            {% endif %}

                            {% if metrics.book_value and metrics.book_value > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Book Value</span>
                                <span class="fund-metric-value">₹{{ "%.0f"|format(metrics.book_value) }}</span>
                            </div>
                            {% endif %}

                            {% if metrics.dividend_yield and metrics.dividend_yield > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Dividend Yield</span>
                                <span class="fund-metric-value">{{ "%.2f"|format(metrics.dividend_yield) }}%</span>
                            </div>
                            {% endif %}

                            {% if metrics.roce and metrics.roce > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">ROCE</span>
                                <span class="fund-metric-value">{{ "%.2f"|format(metrics.roce * 100) }}%</span>
                            </div>
                            {% endif %}

                            {% if metrics.roe and metrics.roe > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">ROE</span>
                                <span class="fund-metric-value">{{ "%.2f"|format(metrics.roe * 100) }}%</span>
                            </div>
                            {% endif %}

                            {% if metrics.face_value and metrics.face_value > 0 %}
                            <div class="fund-metric-row">
                                <span class="fund-metric-label">Face Value</span>
                                <span class="fund-metric-value">₹{{ "%.1f"|format(metrics.face_value) }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- About Sidebar -->
                    <aside class="fund-about-section">
                        <h3>ABOUT</h3>
                        <p>
                            {{ symbol }} is a publicly listed company on the Bombay Stock Exchange (BSE).
                            This comprehensive fundamental analysis provides detailed financial data, key metrics,
                            and historical performance to help you make informed investment decisions.
                        </p>
                        <div class="fund-key-points">
                            <h3>KEY HIGHLIGHTS</h3>
                            <ul>
                                {% if metrics.current_price and metrics.current_price > 0 %}
                                <li><strong>Current Price:</strong> ₹{{ "{:,.2f}".format(metrics.current_price) }}</li>
                                {% endif %}
                                {% if (metrics.low_52w and metrics.low_52w > 0) or (metrics.high_52w and
                                metrics.high_52w > 0) %}
                                <li><strong>52-Week Range:</strong> ₹{{ "%.0f"|format(metrics.low_52w if metrics.low_52w
                                    else 0) }} - ₹{{ "%.0f"|format(metrics.high_52w if metrics.high_52w else 0) }}</li>
                                {% endif %}
                                {% if metrics.market_cap and metrics.market_cap > 0 %}
                                <li><strong>Market Capitalization:</strong> ₹{{ "{:,.0f}".format(metrics.market_cap) }}
                                    Cr</li>
                                {% endif %}
                                {% if metrics.stock_pe and metrics.stock_pe > 0 %}
                                <li><strong>P/E Ratio:</strong> {{ "%.1f"|format(metrics.stock_pe) }}x</li>
                                {% endif %}
                            </ul>
                        </div>
                    </aside>
                </div>
            </div>
        </section>

        <!-- Price Chart Section -->
        <section id="chart" class="fund-content-section">
            <div class="fund-section">
                <h2 class="fund-section-title">Price Chart</h2>

                <div class="fund-chart-header">
                    <div class="fund-chart-controls">
                        <button class="fund-chart-period-btn" data-period="1M">1M</button>
                        <button class="fund-chart-period-btn" data-period="6M">6M</button>
                        <button class="fund-chart-period-btn" data-period="1Y">1Y</button>
                        <button class="fund-chart-period-btn" data-period="3Y">3Y</button>
                        <button class="fund-chart-period-btn active" data-period="5Y">5Y</button>
                        <button class="fund-chart-period-btn" data-period="10Y">10Y</button>
                        <button class="fund-chart-period-btn" data-period="MAX">Max</button>
                    </div>
                    <div class="fund-chart-options">
                        <button class="fund-chart-option-btn active">Price Chart</button>
                    </div>
                </div>

                <div class="fund-chart-container">
                    <canvas id="priceChart"></canvas>
                </div>

                <div class="fund-chart-footer">
                    <label class="fund-chart-checkbox">
                        <input type="checkbox" checked>
                        <span>Price</span>
                    </label>
                    <label class="fund-chart-checkbox">
                        <input type="checkbox" checked>
                        <span>Volume</span>
                    </label>
                </div>
            </div>
        </section>

        <!-- Financial Data Sections -->
        <section id="quarters" class="fund-content-section">
            {{ render_financial_table(quarterly, "Quarterly Results", 13) }}
        </section>

        <section id="profit-loss" class="fund-content-section">
            {{ render_financial_table(pnl, "Profit & Loss Statement", 13) }}
        </section>

        <section id="balance-sheet" class="fund-content-section">
            {{ render_financial_table(balance_sheet, "Balance Sheet", 13) }}
        </section>

        <section id="cash-flow" class="fund-content-section">
            {{ render_financial_table(cashflow, "Cash Flow Statement", 13) }}
        </section>

        <section id="ratios" class="fund-content-section">
            {{ render_financial_table(ratios, "Financial Ratios", 13) }}
        </section>

        <section id="shareholding" class="fund-content-section">
            {{ render_financial_table(shareholding, "Shareholding Pattern", 13) }}
        </section>

    </main>
</div>

{% endblock %}

{% block page_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script id="chart-data-json" type="application/json">{{ chart_data | tojson }}</script>
<script>
    // Price chart data
    const chartDataBlock = document.getElementById('chart-data-json');
    const chartData = chartDataBlock ? JSON.parse(chartDataBlock.textContent) : [];
    let chartInstance = null;

    // Filter data by time period
    function filterDataByPeriod(data, period) {
        if (!data || data.length === 0) return data;

        const now = new Date();
        let cutoffDate;

        switch (period) {
            case '1M': cutoffDate = new Date(now.setMonth(now.getMonth() - 1)); break;
            case '6M': cutoffDate = new Date(now.setMonth(now.getMonth() - 6)); break;
            case '1Y': cutoffDate = new Date(now.setFullYear(now.getFullYear() - 1)); break;
            case '3Y': cutoffDate = new Date(now.setFullYear(now.getFullYear() - 3)); break;
            case '5Y': cutoffDate = new Date(now.setFullYear(now.getFullYear() - 5)); break;
            case '10Y': cutoffDate = new Date(now.setFullYear(now.getFullYear() - 10)); break;
            case 'MAX': return data;
            default: return data;
        }

        return data.filter(item => new Date(item.date) >= cutoffDate);
    }

    // Update chart with current settings
    function updateChart(period = '5Y') {
        if (!chartData || chartData.length === 0) return;

        const filteredData = filterDataByPeriod(chartData, period);
        const dates = filteredData.map(d => d.date);
        const prices = filteredData.map(d => parseFloat(d.value));
        const volumes = prices.map(() => Math.random() * 1000000 + 500000);

        const checkboxes = document.querySelectorAll('.fund-chart-checkbox input[type="checkbox"]');
        const showPrice = checkboxes[0] ? checkboxes[0].checked : true;
        const showVolume = checkboxes[1] ? checkboxes[1].checked : true;

        const datasets = [];

        if (showVolume) {
            datasets.push({
                label: 'Volume',
                type: 'bar',
                data: volumes,
                backgroundColor: 'rgba(99, 102, 241, 0.2)',
                borderColor: 'rgba(99, 102, 241, 0.4)',
                borderWidth: 0,
                yAxisID: 'y1',
                order: 2
            });
        }

        if (showPrice) {
            datasets.push({
                label: 'Price',
                type: 'line',
                data: prices,
                borderColor: '#6366f1',
                backgroundColor: 'transparent',
                borderWidth: 3,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#6366f1',
                tension: 0.2,
                fill: false,
                yAxisID: 'y',
                order: 1
            });
        }

        const ctx = document.getElementById('priceChart');
        if (!ctx) return;

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: dates, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.95)',
                        padding: 16,
                        displayColors: false,
                        titleColor: '#fff',
                        bodyColor: '#e5e7eb',
                        titleFont: { size: 14, weight: '600' },
                        bodyFont: { size: 13 },
                        borderColor: '#4b5563',
                        borderWidth: 1,
                        cornerRadius: 8,
                        callbacks: {
                            title: (tooltipItems) => tooltipItems[0].label,
                            label: (context) => {
                                if (context.dataset.label === 'Price') {
                                    return '₹' + context.parsed.y.toFixed(2);
                                } else {
                                    return 'Vol: ' + Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: { display: false },
                        ticks: { maxTicksLimit: 12, autoSkip: true, color: '#9ca3af', font: { size: 11 } }
                    },
                    y: {
                        display: showPrice,
                        position: 'right',
                        grid: { color: 'rgba(229, 231, 235, 0.5)', drawBorder: false },
                        ticks: {
                            color: '#6b7280',
                            callback: (value) => '₹' + value.toLocaleString()
                        }
                    },
                    y1: {
                        display: showVolume,
                        position: 'left',
                        grid: { display: false },
                        ticks: {
                            color: '#9ca3af',
                            callback: (value) => {
                                if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                                return value;
                            }
                        }
                    }
                }
            }
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        if (chartData && chartData.length > 0) {
            updateChart('5Y');

            // Period button listeners
            document.querySelectorAll('.fund-chart-period-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.fund-chart-period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateChart(this.getAttribute('data-period'));
                });
            });

            // Checkbox listeners
            document.querySelectorAll('.fund-chart-checkbox input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const activeBtn = document.querySelector('.fund-chart-period-btn.active');
                    updateChart(activeBtn ? activeBtn.getAttribute('data-period') : '5Y');
                });
            });
        }
    });

    // Tab navigation
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('.fund-nav-tab');
        const sections = document.querySelectorAll('.fund-content-section[id]');
        let isClickScrolling = false;

        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = tab.getAttribute('href');
                const targetSection = document.querySelector(targetId);

                if (targetSection) {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    isClickScrolling = true;

                    const navHeight = 100;
                    const targetPosition = targetSection.offsetTop - navHeight;

                    window.scrollTo({ top: targetPosition, behavior: 'smooth' });
                    setTimeout(() => { isClickScrolling = false; }, 800);
                }
            });
        });

        function updateActiveTab() {
            if (isClickScrolling) return;

            let current = '';
            const scrollPos = window.scrollY;
            const navHeight = 120;

            sections.forEach(section => {
                const sectionTop = section.offsetTop - navHeight - 50;
                const sectionBottom = sectionTop + section.offsetHeight;
                if (scrollPos >= sectionTop && scrollPos < sectionBottom) {
                    current = section.getAttribute('id');
                }
            });

            if (!current && scrollPos < 300) current = 'summary';

            if (current) {
                tabs.forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.getAttribute('href') === '#' + current) {
                        tab.classList.add('active');
                    }
                });
            }
        }

        updateActiveTab();
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateActiveTab, 50);
        });
    });
</script>
{% endblock %}
